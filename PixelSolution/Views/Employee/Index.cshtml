@model PixelSolution.ViewModels.DashboardViewModel
@{
    ViewData["Title"] = "Employee Dashboard - PixelSolution";
    Layout = "_EmployeeLayout";
}

@section Styles {
    <link href="~/css/dashboard.css" rel="stylesheet">
    <style>
        .growth-indicator {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
        }

        .growth-indicator.positive {
            color: #10b981;
            background-color: rgba(16, 185, 129, 0.1);
        }

        .growth-indicator.negative {
            color: #ef4444;
            background-color: rgba(239, 68, 68, 0.1);
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 1rem;
            z-index: 1000;
            min-width: 300px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            border-left: 4px solid #ef4444;
        }

        .toast.success {
            border-left: 4px solid #10b981;
        }

        .toast.info {
            border-left: 4px solid #3b82f6;
        }

        .btn-secondary {
            background-color: #6b7280;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background-color 0.2s;
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #4b5563;
        }

        .btn-disabled {
            background-color: #d1d5db;
            color: #9ca3af;
            cursor: not-allowed;
        }

        .pagination-controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
}

<!-- Employee Sidebar -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <div class="logo-container">
            <div class="logo-icon">
                <i class="fas fa-bolt"></i>
            </div>
            <div class="logo-text">PixelSolution</div>
        </div>
        <div class="user-info">
            <div class="user-avatar">@User.Identity.Name?.Substring(0, 2).ToUpper()</div>
            <div class="user-details">
                <h4>@User.Identity.Name</h4>
                <p>Employee</p>
            </div>
        </div>
    </div>

    <nav class="nav-menu">
        <div class="nav-section">
            <div class="nav-section-title">Main</div>
            <div class="nav-item">
                <a href="@Url.Action("Index", "Employee")" class="nav-link active">
                    <i class="fas fa-chart-pie"></i>
                    Dashboard
                </a>
            </div>
            <div class="nav-item">
                <a href="@Url.Action("Sales", "Employee")" class="nav-link">
                    <i class="fas fa-shopping-cart"></i>
                    Sales
                    <span class="nav-badge" id="salesCount">0</span>
                </a>
            </div>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">Communication</div>
            <div class="nav-item">
                <a href="@Url.Action("Messages", "Employee")" class="nav-link">
                    <i class="fas fa-envelope"></i>
                    Messages
                    <span class="nav-badge" id="unreadMessagesCount">0</span>
                </a>
            </div>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">Account</div>
            <div class="nav-item">
                <a href="@Url.Action("LogoutGet", "Auth")" class="nav-link">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </a>
            </div>
        </div>
    </nav>
</div>

<!-- Main Content -->
<div class="main-content" id="mainContent">
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <button class="sidebar-toggle" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
            <h1 class="page-title">Employee Dashboard</h1>
        </div>
        <div class="header-right">
            <div class="search-container">
                <input type="text" class="search-input" placeholder="Search anything...">
                <i class="fas fa-search search-icon"></i>
            </div>
            <div class="header-actions">
                <button class="action-btn" title="Notifications">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge">3</span>
                </button>
                <button class="action-btn" title="Messages">
                    <i class="fas fa-envelope"></i>
                    <span class="notification-badge">8</span>
                </button>
                <button class="action-btn" title="Profile">
                    <i class="fas fa-user-circle"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Dashboard Content -->
    <div class="dashboard-content">
        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card" style="--card-color: #3b82f6;">
                <div class="stat-header">
                    <div class="stat-icon">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-trend positive" id="salesTrend">
                        <i class="fas fa-arrow-up"></i>
                        +0.0%
                    </div>
                </div>
                <div class="stat-value" id="totalSalesValue">KSh 0</div>
                <div class="stat-label">My Sales Today</div>
            </div>

            <div class="stat-card" style="--card-color: #10b981;">
                <div class="stat-header">
                    <div class="stat-icon">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div class="stat-trend positive">
                        <i class="fas fa-arrow-up"></i>
                        +8.2%
                    </div>
                </div>
                <div class="stat-value" id="totalOrdersValue">0</div>
                <div class="stat-label">My Transactions</div>
            </div>

            <div class="stat-card" style="--card-color: #f59e0b;">
                <div class="stat-header">
                    <div class="stat-icon">
                        <i class="fas fa-box"></i>
                    </div>
                    <div class="stat-trend negative">
                        <i class="fas fa-arrow-down"></i>
                        -2.1%
                    </div>
                </div>
                <div class="stat-value" id="productsSoldValue">0</div>
                <div class="stat-label">Products Sold</div>
            </div>

            <div class="stat-card" style="--card-color: #8b5cf6;">
                <div class="stat-header">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-trend positive">
                        <i class="fas fa-arrow-up"></i>
                        +3.4%
                    </div>
                </div>
                <div class="stat-value" id="newCustomersValue">0</div>
                <div class="stat-label">Customers Served</div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <h3 class="chart-title">My Sales Performance</h3>
                        <p class="chart-subtitle">Monthly sales performance</p>
                    </div>
                </div>
                <canvas id="salesChart" width="400" height="200"></canvas>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <h3 class="chart-title">Top Products I Sold</h3>
                        <p class="chart-subtitle">Best selling items by me</p>
                    </div>
                </div>
                <canvas id="productsChart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Recent Activity Table -->
        <div class="table-card">
            <div class="table-header">
                <h3 class="table-title">My Recent Sales</h3>
                <div class="table-actions">
                    <button class="btn-primary" onclick="createNewSale()">
                        <i class="fas fa-plus"></i>
                        New Sale
                    </button>
                </div>
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Sale ID</th>
                        <th>Customer</th>
                        <th>Product</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="recentSalesTable">
                    <!-- Sales data will be loaded dynamically -->
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="~/js/dashboard.js"></script>

    <script>
        // Employee-specific functions
        function createNewSale() {
            window.location.href = '@Url.Action("Sales", "Employee")';
        }

        function viewSale(saleId) {
            window.location.href = '@Url.Action("Details", "Employee")?id=' + saleId;
        }

        function printSale(saleId) {
            window.open('@Url.Action("Receipt", "Employee")?id=' + saleId, '_blank');
        }

        let chartsInitialized = false;

        // Load real-time data from database
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing employee dashboard...');
            
            // Initialize charts first
            initializeCharts();
            
            // Wait a bit for charts to be ready, then load data
            setTimeout(() => {
                loadDashboardData();
            }, 500);
            
            // Auto-refresh data every 30 seconds
            setInterval(function() {
                loadDashboardData();
            }, 30000);
        });

        function updateChartsData(chartData) {
            if (!chartsInitialized) {
                console.log('Charts not initialized yet');
                return;
            }

            console.log('Updating charts with data:', chartData);

            // Update Sales Chart
            if (salesChart && chartData.salesData && Array.isArray(chartData.salesData)) {
                console.log('Updating sales chart with:', chartData.salesData);
                salesChart.data.labels = chartData.salesData.map(item => item.date);
                salesChart.data.datasets[0].data = chartData.salesData.map(item => item.amount);
                salesChart.update('active');
                console.log('Sales chart updated successfully');
            } else {
                console.error('Sales chart data is invalid:', chartData.salesData);
            }

            // Update Products Chart
            if (productsChart && chartData.topProducts && Array.isArray(chartData.topProducts)) {
                console.log('Updating products chart with:', chartData.topProducts);
                productsChart.data.labels = chartData.topProducts.map(item => item.productName);
                productsChart.data.datasets[0].data = chartData.topProducts.map(item => item.salesCount);
                productsChart.update('active');
                console.log('Products chart updated successfully');
            } else {
                console.error('Products chart data is invalid:', chartData.topProducts);
                // Show empty state for products chart
                if (productsChart) {
                    productsChart.data.labels = ['No Data'];
                    productsChart.data.datasets[0].data = [1];
                    productsChart.data.datasets[0].backgroundColor = ['#e5e7eb'];
                    productsChart.update('active');
                }
            }
        }

        function initializeCharts() {
            console.log('Initializing employee charts...');
            
            // Destroy existing charts if they exist
            if (salesChart) {
                console.log('Destroying existing sales chart');
                salesChart.destroy();
                salesChart = null;
            }
            if (productsChart) {
                console.log('Destroying existing products chart');
                productsChart.destroy();
                productsChart = null;
            }

            // Sales Overview Chart
            const salesCtx = document.getElementById('salesChart');
            if (salesCtx) {
                console.log('Creating sales chart...');
                salesChart = new Chart(salesCtx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                        datasets: [{
                            label: 'Monthly Sales (KSh)',
                            data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: '#f3f4f6'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return 'KSh ' + value.toLocaleString();
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
                console.log('Sales chart created successfully');
            }

            // Top Products Chart
            const productsCtx = document.getElementById('productsChart');
            if (productsCtx) {
                console.log('Creating products chart...');
                productsChart = new Chart(productsCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['No Data'],
                        datasets: [{
                            label: 'Sales Count',
                            data: [1],
                            backgroundColor: ['#e5e7eb'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': ' + context.parsed + ' sales';
                                    }
                                }
                            }
                        }
                    }
                });
                console.log('Products chart created successfully');
            }

            chartsInitialized = true;
            console.log('Charts initialization completed, chartsInitialized:', chartsInitialized);
        }

        async function loadDashboardData() {
            try {
                console.log('Fetching employee dashboard data...');
                const response = await fetch('@Url.Action("GetDashboardData", "Employee")');
                if (!response.ok) {
                    throw new Error('Failed to fetch dashboard data');
                }
                
                const data = await response.json();
                console.log('Employee dashboard data loaded:', data);
                
                // Update statistics
                updateStatistics(data.stats);
                
                // Update charts
                if (data.charts && data.charts.salesData && data.charts.topProducts) {
                    console.log('Calling updateChartsData with valid data structure');
                    updateChartsData(data.charts);
                }
                
                // Update recent sales table
                updateRecentSalesTable(data.recentSales);
                
                // Update sidebar counts
                updateSidebarCounts(data.sidebarCounts);
                
            } catch (error) {
                console.error('Error loading employee dashboard data:', error);
                showToast('Error loading dashboard data', 'error');
            }
        }

        function updateSidebarCounts(counts) {
            if (!counts) return;
            
            // Update sales count (today's sales)
            const salesCountEl = document.getElementById('salesCount');
            if (salesCountEl && counts.todaySales !== undefined) {
                salesCountEl.textContent = counts.todaySales;
                salesCountEl.style.display = counts.todaySales > 0 ? 'inline' : 'none';
            }
            
            // Update unread messages count
            const unreadMessagesEl = document.getElementById('unreadMessagesCount');
            if (unreadMessagesEl && counts.unreadMessages !== undefined) {
                unreadMessagesEl.textContent = counts.unreadMessages;
                unreadMessagesEl.style.display = counts.unreadMessages > 0 ? 'inline' : 'none';
            }
        }

        function updateStatistics(stats) {
            console.log('Updating employee statistics with:', stats);
            
            // Update Total Sales - use thisMonthSales for better visibility
            const totalSalesElement = document.getElementById('totalSalesValue');
            if (totalSalesElement && stats.thisMonthSales) {
                animateValue(totalSalesElement, 0, stats.thisMonthSales.value, 2000, true);
            }

            // Update Total Orders - use thisMonthOrders
            const totalOrdersElement = document.getElementById('totalOrdersValue');
            if (totalOrdersElement && stats.thisMonthOrders !== undefined) {
                animateValue(totalOrdersElement, 0, stats.thisMonthOrders, 2000, false);
            }

            // Update Products Sold
            const productsSoldElement = document.getElementById('productsSoldValue');
            if (productsSoldElement && stats.productsSold !== undefined) {
                animateValue(productsSoldElement, 0, stats.productsSold, 2000, false);
            }

            // Update New Customers
            const newCustomersElement = document.getElementById('newCustomersValue');
            if (newCustomersElement && stats.newCustomers !== undefined) {
                animateValue(newCustomersElement, 0, stats.newCustomers, 2000, false);
            }

            // Update growth indicators
            updateGrowthIndicators(stats);
        }

        function updateGrowthIndicators(stats) {
            // Update sales growth indicator
            const salesTrend = document.getElementById('salesTrend');
            if (salesTrend && stats.thisMonthSales) {
                const growth = stats.thisMonthSales.growth || 0;
                const isPositive = growth >= 0;
                salesTrend.className = `stat-trend ${isPositive ? 'positive' : 'negative'}`;
                salesTrend.innerHTML = `
                    <i class="fas fa-arrow-${isPositive ? 'up' : 'down'}"></i>
                    ${isPositive ? '+' : ''}${growth.toFixed(1)}%
                `;
            }
        }

        function animateValue(element, start, end, duration, isCurrency = false) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const current = Math.floor(progress * (end - start) + start);

                if (isCurrency) {
                    element.textContent = 'KSh ' + current.toLocaleString();
                } else {
                    element.textContent = current.toLocaleString();
                }

                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        // Pagination variables
        let currentPage = 1;
        let itemsPerPage = 10;
        let allSalesData = [];

        function updateRecentSalesTable(recentSales) {
            allSalesData = recentSales || [];
            displaySalesPage(currentPage);
        }

        function displaySalesPage(page) {
            const tableBody = document.getElementById('recentSalesTable');
            if (!tableBody) return;

            tableBody.innerHTML = '';

            if (!allSalesData || allSalesData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #6b7280;">No recent sales found</td></tr>';
                updatePaginationControls(0);
                return;
            }

            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = allSalesData.slice(startIndex, endIndex);

            pageData.forEach(sale => {
                const row = document.createElement('tr');
                
                const statusClass = sale.status === 'Completed' ? 'status-active' : 'status-pending';
                const formattedDate = new Date(sale.saleDate).toLocaleDateString('en-GB');
                
                row.innerHTML = `
                    <td>${sale.saleNumber || '#' + sale.saleId}</td>
                    <td>${sale.customerName || 'Walk-in Customer'}</td>
                    <td>${sale.productName}</td>
                    <td>KSh ${sale.totalAmount.toLocaleString()}</td>
                    <td><span class="status-badge ${statusClass}">${sale.status}</span></td>
                    <td>${formattedDate}</td>
                    <td>
                        <a href="@Url.Action("Receipt", "Employee")?saleId=${sale.saleId}" 
                           class="action-btn btn-view" 
                           target="_blank"
                           title="Generate Receipt">
                            <i class="fas fa-receipt"></i>
                        </a>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });

            updatePaginationControls(allSalesData.length);
        }

        function updatePaginationControls(totalItems) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            let paginationHtml = '';

            if (totalPages > 1) {
                paginationHtml = `
                    <div class="pagination-controls" style="display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: 1rem;">
                        <button class="btn ${currentPage === 1 ? 'btn-disabled' : 'btn-secondary'}" 
                                onclick="changePage(${currentPage - 1})" 
                                ${currentPage === 1 ? 'disabled' : ''}>
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        <span style="color: #6b7280; font-size: 0.875rem;">
                            Page ${currentPage} of ${totalPages} (${totalItems} items)
                        </span>
                        <button class="btn ${currentPage === totalPages ? 'btn-disabled' : 'btn-secondary'}" 
                                onclick="changePage(${currentPage + 1})" 
                                ${currentPage === totalPages ? 'disabled' : ''}>
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                `;
            }

            // Add pagination controls after the table
            let paginationContainer = document.getElementById('paginationContainer');
            if (!paginationContainer) {
                paginationContainer = document.createElement('div');
                paginationContainer.id = 'paginationContainer';
                const tableCard = document.querySelector('.table-card');
                if (tableCard) {
                    tableCard.appendChild(paginationContainer);
                }
            }
            paginationContainer.innerHTML = paginationHtml;
        }

        function changePage(newPage) {
            const totalPages = Math.ceil(allSalesData.length / itemsPerPage);
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                displaySalesPage(currentPage);
            }
        }
    </script>
}
