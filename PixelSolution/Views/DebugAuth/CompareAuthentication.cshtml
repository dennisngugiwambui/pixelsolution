@{
    ViewData["Title"] = "Debug Authentication Comparison";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Authentication Debug Comparison</h3>
                </div>
                <div class="card-body">
                    @if (ViewBag.Error != null)
                    {
                        <div class="alert alert-danger">
                            <strong>Error:</strong> @ViewBag.Error
                            @if (ViewBag.StackTrace != null)
                            {
                                <pre class="mt-2">@ViewBag.StackTrace</pre>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="mb-3">
                            <h5>Testing Credentials:</h5>
                            <p><strong>Email:</strong> @ViewBag.Email</p>
                            <p><strong>Password:</strong> @ViewBag.Password</p>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <h5>Database Information</h5>
                                <div class="alert @(ViewBag.UserFound ? "alert-success" : "alert-danger")">
                                    <strong>User Found:</strong> @(ViewBag.UserFound ? "‚úÖ YES" : "‚ùå NO")
                                </div>
                                @if (ViewBag.UserFound)
                                {
                                    <div class="alert alert-info">
                                        <strong>User Status:</strong> @ViewBag.UserStatus<br>
                                        <strong>User Type:</strong> @ViewBag.UserType<br>
                                        <strong>Current Hash:</strong><br>
                                        <code style="word-break: break-all;">@ViewBag.CurrentHash</code>
                                    </div>
                                }
                            </div>

                            <div class="col-md-6">
                                <h5>Authentication Tests</h5>
                                
                                <div class="alert @(ViewBag.UtilityTest ? "alert-success" : "alert-danger")">
                                    <strong>1. PasswordUtility Test:</strong> @(ViewBag.UtilityTest ? "‚úÖ PASSED" : "‚ùå FAILED")
                                </div>

                                <div class="alert @(ViewBag.AuthServiceTest ? "alert-success" : "alert-danger")">
                                    <strong>2. AuthService Test:</strong> @(ViewBag.AuthServiceTest ? "‚úÖ PASSED" : "‚ùå FAILED")
                                    @if (ViewBag.AuthServiceTest)
                                    {
                                        <br><small>Authenticated User: @ViewBag.AuthServiceUser</small>
                                    }
                                </div>

                                <div class="alert @(ViewBag.DirectBcryptTest ? "alert-success" : "alert-danger")">
                                    <strong>3. Direct BCrypt Test:</strong> @(ViewBag.DirectBcryptTest ? "‚úÖ PASSED" : "‚ùå FAILED")
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <h5>Analysis</h5>
                            @if (ViewBag.UtilityTest && ViewBag.AuthServiceTest && ViewBag.DirectBcryptTest)
                            {
                                <div class="alert alert-success">
                                    <strong>‚úÖ All tests passed!</strong> The password authentication should work correctly.
                                </div>
                            }
                            else if (ViewBag.UtilityTest && ViewBag.DirectBcryptTest && !ViewBag.AuthServiceTest)
                            {
                                <div class="alert alert-warning">
                                    <strong>‚ö†Ô∏è AuthService Issue:</strong> The password hash is correct, but AuthService is failing. Check AuthService logic or user status validation.
                                </div>
                            }
                            else if (!ViewBag.UtilityTest && !ViewBag.AuthServiceTest && !ViewBag.DirectBcryptTest)
                            {
                                <div class="alert alert-danger">
                                    <strong>‚ùå Password Hash Issue:</strong> All tests failed. The password hash in the database is still incorrect.
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-info">
                                    <strong>üîç Mixed Results:</strong> Some tests passed and others failed. This indicates a specific issue that needs investigation.
                                </div>
                            }
                        </div>

                        <div class="mt-4">
                            <a href="@Url.Action("Login", "Auth")" class="btn btn-primary">
                                Try Login Page
                            </a>
                            <a href="@Url.Action("CompareAuthentication", "DebugAuth")" class="btn btn-secondary">
                                Run Test Again
                            </a>
                            <a href="@Url.Action("FixAdminPassword", "PasswordFix")" class="btn btn-info">
                                Password Fix Utility
                            </a>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>
