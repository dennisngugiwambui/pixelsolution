@model PixelSolution.ViewModels.SaleDetailsViewModel
@{
    ViewData["Title"] = "Receipt";
    Layout = null;
    
    // Calculate totals once at the top to avoid scope issues
    var receiptSubtotal = Model.Items.Sum(i => i.TotalPrice);
    var receiptTax = receiptSubtotal * 0.15m; // 15% VAT as specified
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Receipt - @Model.SaleNumber</title>
    <style>
        /* PDF-optimized styles */
        @@page {
            size: 80mm auto;
            margin: 2mm;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.4;
            color: #000;
            background: #fff;
            width: 76mm;
            margin: 0 auto;
            padding: 3mm;
        }

        .receipt-container {
            width: 100%;
            max-width: 70mm;
            margin: 0 auto;
            background: #fff;
        }

        .receipt-header {
            text-align: center;
            margin-bottom: 8px;
            border-bottom: 1px solid #000;
            padding-bottom: 5px;
        }

        .company-name {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .company-details {
            font-size: 9px;
            margin-bottom: 1px;
        }

        .receipt-info {
            margin: 8px 0;
            font-size: 10px;
        }

        .receipt-info div {
            margin-bottom: 2px;
        }

        .items-section {
            margin: 8px 0;
            border-top: 1px dashed #000;
            border-bottom: 1px dashed #000;
            padding: 5px 0;
        }

        .item-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
            font-size: 10px;
        }

        .item-details {
            flex: 1;
        }

        .item-price {
            text-align: right;
            min-width: 15mm;
        }

        .totals-section {
            margin: 8px 0;
            font-size: 10px;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
        }

        .final-total {
            border-top: 1px solid #000;
            padding-top: 3px;
            margin-top: 5px;
            font-weight: bold;
            font-size: 12px;
        }

        .payment-section {
            margin: 8px 0;
            font-size: 10px;
        }

        .payment-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
        }

        .receipt-footer {
            text-align: center;
            margin-top: 10px;
            border-top: 1px dashed #000;
            padding-top: 5px;
            font-size: 9px;
        }

        .thank-you {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .footer-details {
            margin-bottom: 2px;
        }

        .generation-info {
            margin-top: 5px;
            font-size: 8px;
            color: #666;
        }

        /* Hide everything except receipt for print */
        @@media print {
            body {
                margin: 0;
                padding: 0;
                width: auto;
            }
            
            .receipt-container {
                max-width: none;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="receipt-container">
        <!-- Receipt Header -->
        <div class="receipt-header">
            <div class="company-name">PIXEL SOLUTION</div>
            <div class="company-details">Chuka, Ndangani</div>
            <div class="company-details">Tel: +254758024400</div>
            <div class="company-details">www.pixelsolution.co.ke</div>
        </div>

        <!-- Receipt Info -->
        <div class="receipt-info">
            <div>Receipt: @Model.SaleNumber</div>
            <div>Date: @Model.SaleDate.ToString("dd/MM/yyyy HH:mm:ss")</div>
            <div>Served by: @Model.CashierName</div>
            @if (!string.IsNullOrEmpty(Model.CustomerName))
            {
                <div>Customer: @Model.CustomerName</div>
            }
        </div>

        <!-- Items Section -->
        <div class="items-section">
            @foreach (var item in Model.Items)
            {
                <div class="item-row">
                    <div class="item-details">
                        <div>@item.ProductName</div>
                        <div style="font-size: 9px;">@item.Quantity x KSh @item.UnitPrice.ToString("N2")</div>
                    </div>
                    <div class="item-price">
                        KSh @item.TotalPrice.ToString("N2")
                    </div>
                </div>
            }
        </div>

        <!-- Totals Section -->
        <div class="totals-section">
            <div class="total-row">
                <span>Subtotal:</span>
                <span>KSh @receiptSubtotal.ToString("N2")</span>
            </div>
            <div class="total-row">
                <span>VAT (15%):</span>
                <span>KSh @receiptTax.ToString("N2")</span>
            </div>
            <div class="final-total">
                <div class="total-row">
                    <span>TOTAL:</span>
                    <span>KSh @Model.TotalAmount.ToString("N2")</span>
                </div>
            </div>
        </div>

        <!-- Payment Section -->
        <div class="payment-section">
            <div class="payment-row">
                <span>Payment Method:</span>
                <span>@Model.PaymentMethod</span>
            </div>
            <div class="payment-row">
                <span>Amount Paid:</span>
                <span>KSh @Model.AmountPaid.ToString("N2")</span>
            </div>
            @if (Model.ChangeGiven > 0)
            {
                <div class="payment-row" style="font-weight: bold;">
                    <span>Change Given:</span>
                    <span>KSh @Model.ChangeGiven.ToString("N2")</span>
                </div>
            }
        </div>

        <!-- Footer -->
        <div class="receipt-footer">
            <div class="thank-you">Thank You for Your Business!</div>
            <div class="footer-details">We appreciate your trust in our services</div>
            <div class="footer-details">Customer Service: +254758024400</div>
            <div class="generation-info">
                Generated on @DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss")
                <br>Powered by PixelSolution POS System
            </div>
        </div>
    </div>

    <script>
        // Auto-open print dialog when page loads
        window.addEventListener('load', function() {
            // Small delay to ensure page is fully rendered
            setTimeout(function() {
                window.print();
            }, 500);
        });

        // Handle after print actions
        window.addEventListener('afterprint', function() {
            // Option 1: Close window if opened in new tab
            if (window.opener) {
                window.close();
            } else {
                // Option 2: Redirect back to sales history
                setTimeout(function() {
                    if (confirm('Receipt printed/saved. Return to Sales History?')) {
                        window.location.href = '/Admin/SalesHistory';
                    }
                }, 1000);
            }
        });

        // Handle print cancellation
        window.addEventListener('beforeprint', function() {
            console.log('Print dialog opened');
        });
    </script>
</body>
</html>
